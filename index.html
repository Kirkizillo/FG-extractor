<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feature Graphic Extractor (w1024)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
    .fade-in { animation: fade 0.4s ease-in-out; }
    @keyframes fade { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <header class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight">Feature Graphic Extractor <span class="text-slate-400">(w1024)</span></h1>
    </header>

    <section class="bg-slate-900/50 border border-slate-800 rounded-2xl p-5 shadow-xl">
      <div class="grid gap-3 mt-6">
        <label class="text-sm text-slate-300" for="input">Gplay URL or package ID:</label>
        <div class="flex gap-2 items-center">
          <input id="input" type="text" placeholder="https://play.google.com/store/apps/details?id=com.example or com.example" class="flex-1 rounded-xl bg-slate-900 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" />
          <button id="go" class="rounded-xl px-4 py-3 bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition text-white font-medium">Extract</button>
          <button id="proxyBtn" class="rounded-xl px-3 py-3 bg-slate-800 hover:bg-slate-700 transition text-slate-200" title="Set proxy (ends with ?url=)">‚öôÔ∏è</button>
        </div>
        <div class="flex items-center gap-3 mt-1">
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input id="keep169" type="checkbox" class="accent-indigo-500" /> Keep 16:9 height (<code>=w1024-h576-rw</code>)
          </label>
        </div>
      </div>

      <div id="status" class="mt-4 text-sm text-slate-400"></div>
    </section>

    <section id="result" class="hidden mt-8 fade-in">
      <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-3">Result</h2>
        <div class="grid gap-3">
          <div class="flex gap-2">
            <input id="outUrl" class="flex-1 rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm" readonly />
            <button id="copyUrl" class="rounded-xl px-3 py-2 bg-slate-800 hover:bg-slate-700 text-sm">Copy URL</button>
          </div>
          <div class="mt-3">
            <img id="preview" alt="Feature graphic preview" class="w-full max-w-2xl rounded-xl border border-slate-800" />
            <div class="mt-2 flex gap-3 text-xs text-slate-400">
              <span id="meta"></span>
              <a id="openRaw" target="_blank" rel="noopener" class="underline">Open image in new tab</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
// --- Constants -----------------------------------------------------------
const IMG_HOST = "play-lh.googleusercontent.com";
const SIZE_RE = /=w(\d+)-h(\d+)/;
const FAV_HEIGHTS = new Set([405, 470, 500, 576]); // frequent banner heights
const SUPER_FAV = new Set(["1024x576","832x470","720x405","1024x500","512x288"]);
const LS_KEY_PROXY = 'fge_proxy_endpoint';
const DEBUG = new URLSearchParams(location.search).get('debug') === '1';

// --- Small utils ---------------------------------------------------------
function normalizeW1024(u, keep) {
  if (!u || !u.includes(IMG_HOST)) return u;
  const base = u.split("=")[0];
  return keep ? `${base}=w1024-h576-rw` : `${base}=w1024`;
}
function extractWH(url) {
  const m = url.match(SIZE_RE);
  if (!m) return null;
  const w = parseInt(m[1], 10), h = parseInt(m[2], 10);
  return { w, h, ratio: h ? w / h : null };
}
function uniqueInOrder(arr) {
  const seen = new Set(); const out = [];
  for (const x of arr) if (!seen.has(x)) { seen.add(x); out.push(x); }
  return out;
}
function byBase(urls){
  const groups = new Map();
  for (const u of urls){ const base=u.split('=')[0]; if(!groups.has(base)) groups.set(base,[]); groups.get(base).push(u); }
  return Array.from(groups.entries()).map(([base,urls])=>({base,urls}));
}

// Decode \uXXXX and \/, then HTML entities
function decodeJSStringEscapes(str){
  try{
    const unescapedUnicode = str.replace(/\\u([0-9a-fA-F]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
    const slashesFixed = unescapedUnicode.replace(/\\\//g,'/');
    const ta = document.createElement('textarea');
    ta.innerHTML = slashesFixed;
    return ta.value;
  }catch{ return str; }
}

// --- Source collectors ---------------------------------------------------
function getScriptBodies(html){
  const bodies=[]; const re=/<script[^>]*>([\\s\\S]*?)<\\/script>/gi; let m;
  while((m=re.exec(html))!==null){ bodies.push(m[1]||''); }
  return bodies;
}
function extractUrlsFromBodies(bodies){
  const urls=[]; const urlRe=/https:\\/\\/play-lh\\.googleusercontent\\.com\\/[A-Za-z0-9_\\-][^\"'<>\\s]*/g;
  for(const raw of bodies){ const dec = decodeJSStringEscapes(raw); const found = dec.match(urlRe) || []; urls.push(...found); }
  return uniqueInOrder(urls);
}

// --- Filters (NUEVO) ----------------------------------------------------
function isAvatarOrJunk(u){
  if (!u.includes(IMG_HOST)) return true;                 // only play-lh
  if (u.includes('/a-/') || u.includes('/a/')) return true; // user avatars
  if (/\\b=mo\\b/.test(u)) return true;                   // mini avatar suffix
  if (!SIZE_RE.test(u)) return true;                      // must have =w###-h###
  return false;
}
function passesSizeRange(u){
  const m = u.match(SIZE_RE);
  if (!m) return false;
  const w = +m[1], h = +m[2];
  if (w < 600 || w > 1400) return false;
  if (h < 300 || h > 700) return false;
  return true;
}

// --- Scoring -------------------------------------------------------------
function scoreUrl(u){
  const s = extractWH(u);
  if (!s || !s.ratio || s.w <= s.h) return -1e9;
  const dev = Math.abs(s.ratio - 16/9);
  if (dev > 0.12) return -1e9;
  let sc = 0;
  sc += dev <= 0.03 ? 8 : 4;                     // closeness to 16:9
  if (FAV_HEIGHTS.has(s.h)) sc += 12;            // banner-like heights
  const pair = `${s.w}x${s.h}`; if (SUPER_FAV.has(pair)) sc += 6;
  if (u.includes('-rw')) sc += 3;                // typical delivery flag
  if ([1080, 720, 480].includes(s.h)) sc -= 8;   // screenshot-ish
  sc += s.h <= 600 ? 3 : -3;                     // avoid very tall
  return sc;
}
function pickBest(urls){ let best=null,bs=-1e9; for(const u of urls){ const s=scoreUrl(u); if(s>bs){ bs=s; best=u; } } return best; }

// --- Core extraction pipeline -------------------------------------------
function extractFeatureGraphic(html){
  // 1) Only AF_initDataCallback scripts (most likely source)
  const onlyInit = getScriptBodies(html).filter(s=>s.includes('AF_initDataCallback'));
  let urls = extractUrlsFromBodies(onlyInit);

  // 2) If none, try all scripts (decoded) as fallback
  if (!urls.length){ urls = extractUrlsFromBodies(getScriptBodies(html)); }

  // 3) If still none, decode whole HTML and try once more
  if (!urls.length){
    const dec = decodeJSStringEscapes(html);
    const all = dec.match(/https:\\/\\/play-lh\\.googleusercontent\\.com\\/[A-Za-z0-9_\\-][^\"'<>\\s]*/g) || [];
    urls = uniqueInOrder(all);
  }

  // üî¥ NUEVO: eliminar avatares/lixo y forzar rango de tama√±o banner
  urls = urls.filter(u => !isAvatarOrJunk(u) && passesSizeRange(u));

  // 4) Agrupar por base y elegir el mejor de cada grupo, luego el mejor global
  const groups = byBase(urls);
  let best=null, bestScore=-1e9;
  for (const g of groups){
    const candidate=pickBest(g.urls);
    if(!candidate) continue;
    const sc=scoreUrl(candidate);
    if(sc>bestScore){ best=candidate; bestScore=sc; }
  }

  if (DEBUG){
    console.log('[FGE] candidates (after filters)', urls.slice(0,50));
    console.log('[FGE] best', best);
  }
  return best;
}

// --- Proxy persistence ---------------------------------------------------
function getProxy(){
  const ls=localStorage.getItem(LS_KEY_PROXY); if(ls) return ls;
  const p=new URLSearchParams(location.search).get('proxy');
  if(p){ localStorage.setItem(LS_KEY_PROXY,p); return p;}
  return null;
}
function setProxyInteractive(){
  const cur=getProxy()||'';
  const val=prompt('Proxy endpoint (must end with ?url=):',cur);
  if(!val) return;
  try{
    new URL(val);
    if(!val.endsWith('=') && !val.endsWith('%3D')) return alert('It should end with ?url=');
    localStorage.setItem(LS_KEY_PROXY,val);
  }catch{ alert('Invalid URL'); }
}

// --- UI wiring -----------------------------------------------------------
const elInput = document.getElementById('input');
const elGo = document.getElementById('go');
const elKeep = document.getElementById('keep169');
const elStatus = document.getElementById('status');
const elRes = document.getElementById('result');
const elOut = document.getElementById('outUrl');
const elCopy = document.getElementById('copyUrl');
const elPrev = document.getElementById('preview');
const elMeta = document.getElementById('meta');
const elOpen = document.getElementById('openRaw');
const elProxyBtn = document.getElementById('proxyBtn');
function setStatus(msg, kind='info'){
  const colors={info:'text-slate-400', ok:'text-emerald-400', err:'text-rose-400'};
  elStatus.className=`mt-4 text-sm ${colors[kind]||colors.info}`;
  elStatus.textContent=msg||'';
}

async function extract(){
  elRes.classList.add('hidden'); setStatus('');
  const pkg = (function getPkg(v){
    const t=v.trim(); if(!t) return null;
    try{ const u=new URL(t); if(u.hostname.includes('play.google.com')) return new URLSearchParams(u.search).get('id'); return null; }
    catch{ return t; }
  })(elInput.value);
  if (!pkg) return setStatus('Enter a Play URL or a valid package ID.','err');
  const proxy = getProxy(); if (!proxy) return setStatus('Set proxy (gear button) first.','err');
  const playUrl = `https://play.google.com/store/apps/details?` + new URLSearchParams({id:pkg, hl:'en', gl:'US'}).toString();
  const target = proxy.endsWith('=') ? proxy + encodeURIComponent(playUrl) : proxy + playUrl;

  setStatus('Fetching page via proxy‚Ä¶'); let html='';
  try{
    const r=await fetch(target);
    if(!r.ok) throw new Error(`Proxy HTTP ${r.status}`);
    html=await r.text();
  } catch(e){ return setStatus(`Fetch failed: ${e.message}`,'err'); }

  // Aviso si a√∫n es p√°gina de consentimiento
  if (/consent|__CONSENT|mCONSENT|consent\\.google/i.test(html)) {
    return setStatus('Google returned a consent page. Update the Worker to send CONSENT cookie and force hl=en&gl=US.', 'err');
  }

  setStatus('Parsing internal data‚Ä¶');
  const feat = extractFeatureGraphic(html);
  if (!feat) return setStatus('No feature graphic found.','err');

  const normalized = normalizeW1024(feat, elKeep.checked);
  elOut.value = normalized; elPrev.src = normalized; elOpen.href = normalized;
  const s = extractWH(feat);
  elMeta.textContent = s ? `Original size tokens: w${s.w}√óh${s.h} (~${(s.ratio).toFixed(3)}:1)` : 'Original size tokens: unknown';
  setStatus('Done ‚úî','ok'); elRes.classList.remove('hidden');
}

elGo.addEventListener('click', extract);
elInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') extract(); });
elCopy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(elOut.value); elCopy.textContent='Copied'; setTimeout(()=> elCopy.textContent='Copy URL', 1000);} catch{} });
elProxyBtn.addEventListener('click', setProxyInteractive);
window.addEventListener('load', ()=>{ if(!getProxy()) setStatus('Click the gear to set your proxy endpoint (ends with ?url=).', 'info'); });
</script>
</body>
</html>
